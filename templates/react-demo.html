{% extends "_base.html" %}

{% block title %}
{{ result_title }}
{% endblock %}

{% block head_stylesheet %}
    <meta property="og:image" content="http://www.dancedeets.com/images/deet-city.jpg" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="{{ result_title }}" /> 
    <meta property="og:site_name" content="DanceDeets"/>
    <meta property="og:description"
          content="Every street dance event. On the web, on your phone. At home, and when traveling."/>
    <script src="https://fb.me/react-0.14.0.js"></script>
    <script src="https://fb.me/react-dom-0.14.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
{% endblock %}

{% block body %}

<div class="row">
<div class="col-md-9">
<div style="margin-bottom: 25px">
  <b>NYC Street Dance Classes</b>
  <br>
  Styles: All
  <br>
  Studios: All
  <br>
  Keywords: <input type=text>
  <br>
  Mon | Tue | Wed | Thu | Fri | Sat | Sun {# a href->a name #}
</div>{# margin-bottom: 25px #}

<hr>

<div style="min-height:300px">

<div class="tabs-after top-to-bottom-fade row">
  <div id="upcoming_events" class="col-md-8 col-xs-12">
  </div>
</div>{# min-height:300px #}
</div>{# col-md-9 #}
</div>{# row #}

<div class="col-md-3">
  <button class="btn btn-primary" onclick="share(); return true;"><i class="fa fa-user-plus fa-lg"></i> Share on Facebook</button>
  <div class="fb-like" data-href="https://www.facebook.com/dancedeets" data-layout="standard" data-width="190" data-action="like" data-show-faces="true" style="margin: 10px 0;"></div>
  <p>
</div>

</div> {# row #}
{% endblock %}

{% block bottom_javascript %}

<!-- if we ever want to add i18n, we can use http://cdnjs.com/libraries/moment.js/ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>

<!-- see below comment near #keywords_input
<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.4/typeahead.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/bootstrap-tokenfield.min.js"></script>
-->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&amp;signed_in=true&amp;libraries=places&amp;callback=initializeLocationAutocomplete"></script>

<script type="text/javascript">
$(document).ready(function(event) {
  $("body").delegate("#location_input", "click", function() { return false; });
  $('#keywords_input').keydown(function(event) {
      if (event.keyCode == 13) {
          this.form.submit();
          return false;
       }
  });
  $('#location_input').keydown(function(event) {
      if (event.keyCode == 13) {
          this.form.submit();
          return false;
       }
  });
  {# Disable keywords_input autocomplete/tokenizer, until we figure out exactly how we want this to work.
  ie, maybe we want to tokenize just magical-portions of the input. But we can make bboy-style events work
  based off matching against the search query serverside, for the moment.
  var engine = new Bloodhound({
    local: {{ keyword_tokens|jsonify }},
    datumTokenizer: function(d) {
      return Bloodhound.tokenizers.whitespace(d.value);
    },
    queryTokenizer: Bloodhound.tokenizers.whitespace
  });
  engine.initialize();
  $('#keywords_input').tokenfield({
    typeahead: [null, { source: engine.ttAdapter() }]
  });
  $('#keywords_input').on('tokenfield:createtoken', function (event) {
    var existingTokens = $(this).tokenfield('getTokens');
    $.each(existingTokens, function(index, token) {
        if (token.value === event.attrs.value)
            event.preventDefault();
    });
  });
  #}
});

function initializeLocationAutocomplete() {
  var autocomplete = new google.maps.places.Autocomplete($('#location_input').get(0));
  autocomplete.setTypes(['(regions)'])
}

function share() {
  FB.ui({
    method: 'share',
    href: 'https://www.dancedeets.com/',
  }, function(response){}); 
}


var classes = [];
{% for group in grouped_upcoming_results %}
  {% for result in group.results %}
    {% if not result.fb_event_id %}
    classes.push({
      'url': '{{result.source_page}}',
      'name': '{{result.name}}',
      'location': '{{result.actual_city_name}}',
      'start_time': moment('{{result.start_time_raw}}'),
      'end_time': moment('{{result.end_time_raw}}'),
      'categories': {{result.categories|safe}}, {# ideally tojson #}
      'sponsor': '{{result.sponsor}}',
      'key': '{{result}}',
    });
    {% endif %}
  {% endfor %}
{% endfor %}
/*
      {% if sponsored_studios['MINDBODY'] %}
        <div style="margin: 1em 0em; font-style: italic">
          Studios Powered by <a href="http://www.mindbodyonline.com">MINDBODY</a>:
          {{ sponsored_studios['MINDBODY']|join(', ') }}
        </div>
      {% endif %}
*/
</script>

<script type="text/babel">


var StudioClass = React.createClass({
  render: function() {
    return (
      <div>
        <a href="{this.props.studio_class.url}">
        {this.props.studio_class.location}: {this.props.studio_class.name}
        </a>
      </div>
    );
  }
});

var DayHeader = React.createClass({
  render: function() {
    return (
      <div>
        <h4>{this.props.date.format("ddd MMM D")}</h4>
      </div>
    );
  }
});

var TimeHeader = React.createClass({
  render: function() {
    return (
      <div>
        <b>{this.props.datetime.format("h:mma")}</b>
      </div>
    );
  }
});

var StudioClasses = React.createClass({
  render: function() {
    var rows = [];
    var last_studio_class = null;
    this.props.classes.forEach(function(studio_class) {
      if (last_studio_class == null || studio_class.start_time.format("YYYY-MM-DD") != last_studio_class.start_time.format("YYYY-MM-DD")) {
        rows.push(<DayHeader date={studio_class.start_time} key={studio_class.start_time.format("YYYY-MM-DD")} />);
      }
      if (last_studio_class == null || studio_class.start_time.format("HH:mm") != last_studio_class.start_time.format("HH:mm")) {
        rows.push(<TimeHeader datetime={studio_class.start_time} key={studio_class.start_time.format("YYYY-MM-DDTHH:mm")} />);
      }
      rows.push(<StudioClass studio_class={studio_class} key={studio_class.key} />);
      last_studio_class = studio_class;
    });
    return <div>{rows}</div>;
  }
});

ReactDOM.render(
  <StudioClasses classes={classes} />,
  document.getElementById('upcoming_events')
);

</script>
{% endblock %}